name: CI

on:
  push:
    branches:
      - master
    paths:
      - 'plugins/**'
      - '!plugins/master.json'

  schedule:
    - cron:  '0 * * * *'

  workflow_dispatch:

concurrency:
  group: ci

jobs:
  update-plugin-master:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1

      - uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version: 1.25

      - uses: chetan/git-restore-mtime-action@cbf8161ddb4e9b162409104954fb540e8a38c1da # v2.1.1

      - name: Generate Plugin Master
        run: |
          go install github.com/SlashNephy/divination-plugin-master-generator@latest
          divination-plugin-master-generator

      - name: Create Pull Request
        id: create-pull-request
        uses: peter-evans/create-pull-request@98357b18bf14b5342f975ff684046ec3b2a07725 # v8.0.0
        with:
          token: ${{ secrets.BOT_GITHUB_TOKEN }}
          commit-message: ðŸª„ Generate Plugin Master
          author: StarryBlueSky-bot <97773209+StarryBlueSky-bot@users.noreply.github.com>
          branch: ci/update-plugin-master
          branch-suffix: random
          delete-branch: true
          title: ðŸª„ Generate Plugin Master
          labels: automerge

      - name: Automerge
        if: steps.create-pull-request.outputs.pull-request-number
        continue-on-error: true
        uses: peter-evans/enable-pull-request-automerge@a660677d5469627102a1c1e11409dd063606628d # v3
        with:
          token: ${{ secrets.BOT_GITHUB_TOKEN }}
          pull-request-number: ${{  steps.create-pull-request.outputs.pull-request-number }}
