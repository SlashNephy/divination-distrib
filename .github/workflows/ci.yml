name: CI

on:
  push:
    branches:
      - master
    paths:
      - 'plugins/**'
      - '!plugins/master.json'

  schedule:
    - cron:  '0 * * * *'

  workflow_dispatch:

concurrency:
  group: ci

jobs:
  update-plugin-master:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
        with:
          go-version: 1.22

      - uses: chetan/git-restore-mtime-action@v2

      - name: Generate Plugin Master
        run: |
          go install github.com/SlashNephy/divination-plugin-master-generator@latest
          divination-plugin-master-generator

      - name: Create Pull Request
        id: create-pull-request
        uses: peter-evans/create-pull-request@271a8d0340265f705b14b6d32b9829c1cb33d45e # v7.0.8
        with:
          token: ${{ secrets.BOT_GITHUB_TOKEN }}
          commit-message: ðŸª„ Generate Plugin Master
          author: StarryBlueSky-bot <97773209+StarryBlueSky-bot@users.noreply.github.com>
          branch: ci/update-plugin-master
          branch-suffix: random
          delete-branch: true
          title: ðŸª„ Generate Plugin Master
          labels: automerge

      - name: Automerge
        if: steps.create-pull-request.outputs.pull-request-number
        continue-on-error: true
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.BOT_GITHUB_TOKEN }}
          pull-request-number: ${{  steps.create-pull-request.outputs.pull-request-number }}
