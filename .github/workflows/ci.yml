name: CI

on:
  push:
    branches:
      - master
    paths:
      - 'plugins/**'
      - '!plugins/master.json'

  schedule:
    - cron:  '0 * * * *'

  workflow_dispatch:

concurrency:
  group: ci

jobs:
  update-plugin-master:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version: 1.26

      - uses: chetan/git-restore-mtime-action@cbf8161ddb4e9b162409104954fb540e8a38c1da # v2.1.1

      - name: Generate Plugin Master
        run: |
          go install github.com/SlashNephy/divination-plugin-master-generator@latest
          divination-plugin-master-generator

      - name: Create Pull Request
        id: create-pull-request
        uses: peter-evans/create-pull-request@c0f553fe549906ede9cf27b5156039d195d2ece0 # v8.1.0
        with:
          token: ${{ secrets.BOT_GITHUB_TOKEN }}
          commit-message: ðŸª„ Generate Plugin Master
          author: StarryBlueSky-bot <97773209+StarryBlueSky-bot@users.noreply.github.com>
          branch: ci/update-plugin-master
          branch-suffix: random
          delete-branch: true
          title: ðŸª„ Generate Plugin Master
          labels: automerge

      - name: Automerge
        if: steps.create-pull-request.outputs.pull-request-number
        continue-on-error: true
        uses: peter-evans/enable-pull-request-automerge@a660677d5469627102a1c1e11409dd063606628d # v3
        with:
          token: ${{ secrets.BOT_GITHUB_TOKEN }}
          pull-request-number: ${{  steps.create-pull-request.outputs.pull-request-number }}
